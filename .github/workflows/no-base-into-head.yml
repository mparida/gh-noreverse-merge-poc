name: Enforce: No base->head merges in PR

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR (or repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure we are on a PR
        id: context
        run: |
          if [ -z "${{ github.event.pull_request.head.ref }}" ]; then
            echo "pr_head_ref=" >> $GITHUB_OUTPUT
            echo "No PR context (push/workflow_dispatch). This run just seeds the status check." 
          else
            echo "pr_head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Seed-only exit on non-PR
        if: steps.context.outputs.pr_head_ref == ''
        run: |
          echo "Seeding check name on main. Nothing to enforce."
          exit 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Compute merge-base
        id: mb
        run: |
          MB=$(git merge-base ${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }})
          echo "mb=$MB" >> $GITHUB_OUTPUT

      - name: Detect merge commits in PR head range
        run: |
          MB="${{ steps.mb.outputs.mb }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          MERGES=$(git rev-list --merges "$MB..$HEAD" || true)
          echo "Merge commits in head since branching point:"
          echo "$MERGES"
          if [ -n "$MERGES" ]; then
            echo "::error::Merge commits detected in PR head (likely 'Update branch' or web conflict editor). Policy forbids base->head merges."
            exit 1
          fi
